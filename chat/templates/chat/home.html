<!DOCTYPE html>
{% load static %}
{% load markdown_deux_tags %}
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediBot - Assistant M√©dical Virtuel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Animation pour les messages */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            animation: fadeIn 0.3s ease-out;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* Pulse animation for bot typing indicator */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .typing-dot {
            animation: pulse 1.5s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.3s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.6s;
        }

        /* Sidebar transition */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 40;
                height: 100vh;
            }

            .sidebar-open {
                transform: translateX(0);
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 30;
            }

            .sidebar-overlay-open {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans flex h-screen overflow-hidden">
<!-- Sidebar Overlay (mobile only) -->
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<!-- Sidebar -->
<div id="sidebar" class="sidebar bg-white w-64 border-r border-gray-200 flex flex-col">
    <!-- New Chat Button -->
    <div class="p-4 border-b border-gray-200">
        <button onclick="newChat()"
                class="w-full flex items-center justify-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition">
            <i class="fas fa-plus"></i>
            <span>Nouvelle discussion</span>
        </button>
    </div>

    <!-- Chat History -->
    <div class="flex-1 overflow-y-auto">
        <div class="p-2">
            <h3 class="px-2 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider">Historique</h3>
            <div id="chat-history" class="space-y-1">
                {% for item in chat_items %}
                    <div onclick="loadConversation({{ item.conversation.id }})"
                         class="px-2 py-2 rounded-lg hover:bg-gray-100 cursor-pointer flex items-center justify-between {% if forloop.first %}bg-gray-100{% endif %}">
                    <span class="truncate">
                        <i class="fas fa-comment-medical mr-2 text-blue-500"></i>
                        {% with first_message=item.messages.first %}
                            {{ first_message.content|truncatechars:30 }}
                        {% endwith %}
                    </span>
                        <i class="fas fa-ellipsis-v text-gray-400 hover:text-gray-600"
                           onclick="event.stopPropagation(); showConversationOptions(event, {{ item.conversation.id }})"></i>
                    </div>
                {% empty %}
                    <div class="px-2 py-2 text-gray-500 text-center">
                        Aucune conversation existante
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <!-- User Profile -->
    <div class="p-4 border-t border-gray-200">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                <i class="fas fa-user text-blue-600"></i>
            </div>
            <div>
                <p class="font-medium">Utilisateur</p>
                <p class="text-xs text-gray-500">Compte gratuit</p>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="flex-1 flex flex-col overflow-hidden">
    <!-- Navbar -->
    <header class="bg-white border-b border-gray-200">
        <div class="flex items-center justify-between px-4 py-3">
            <!-- Mobile menu button -->
            <button id="mobile-menu-button" class="md:hidden text-gray-500 hover:text-gray-600">
                <i class="fas fa-bars text-xl"></i>
            </button>

            <!-- Logo / Title -->
            <div class="flex items-center">
                <img src="{% static 'chat/assets/images/LOGO-UDBL1.png' %}" alt="UDBL Logo" class="h-8 mr-2">
                <h1 class="text-xl font-bold text-gray-800">MediAi</h1>
            </div>

            <!-- Nav Links -->
            <nav class="hidden md:flex space-x-6">
                <a href="#" class="text-gray-700 hover:text-blue-600">Accueil</a>
                <a href="#" class="text-gray-700 hover:text-blue-600">Fonctionnalit√©s</a>
                <a href="#" class="text-gray-700 hover:text-blue-600">√Ä propos</a>
                <a href="#" class="text-gray-700 hover:text-blue-600">Contact</a>
            </nav>

            <!-- User Actions -->
            <div class="flex items-center space-x-4">
                <button class="text-gray-500 hover:text-blue-600">
                    <i class="fas fa-sun"></i>
                </button>
                <button class="text-gray-500 hover:text-blue-600">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                    <i class="fas fa-user text-blue-600"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Chat Container -->
    <div class="flex-1 overflow-y-auto bg-gray-50">
        <div class="max-w-3xl mx-auto p-4">
            <!-- Welcome Message -->
            <div class="flex items-start space-x-3 message mb-6">
                <div class="bg-blue-100 text-blue-800 w-8 h-8 rounded-full flex items-center justify-center shrink-0">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="bg-blue-100 text-blue-800 p-4 rounded-2xl rounded-tl-none max-w-full lg:max-w-3xl">
                    <p class="font-medium">Bonjour üëã</p>
                    <p class="mt-1">Je suis MediAi, votre assistant m√©dical virtuel. Je peux vous aider √†:</p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>Comprendre vos sympt√¥mes</li>
                        <li>Vous orienter vers les bons professionnels</li>
                        <li>Donner des conseils de sant√© g√©n√©raux</li>
                        <li>Rappeler vos m√©dicaments</li>
                    </ul>
                    <p class="mt-2">Comment puis-je vous aider aujourd'hui?</p>

                    <!-- Quick Actions -->
                    <div class="flex flex-wrap gap-2 mt-4">
                        <button onclick="sendQuickMessage('J\'ai mal √† la t√™te')"
                                class="bg-white hover:bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm transition border border-gray-200">
                            J'ai mal √† la t√™te
                        </button>
                        <button onclick="sendQuickMessage('Je cherche un m√©decin g√©n√©raliste')"
                                class="bg-white hover:bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm transition border border-gray-200">
                            Trouver un m√©decin
                        </button>
                        <button onclick="sendQuickMessage('Conseils pour dormir mieux')"
                                class="bg-white hover:bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm transition border border-gray-200">
                            Probl√®mes de sommeil
                        </button>
                        <button onclick="sendQuickMessage('Quand consulter en urgence?')"
                                class="bg-white hover:bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm transition border border-gray-200">
                            Urgence m√©dicale
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="space-y-6">
                {% for item in chat_items %}
                    <div class="conversation-block">
                        {% for message in item.messages %}
                            <div class="flex items-start space-x-3 message {% if message.role == 'user' %}justify-end{% endif %}">
                                {% if message.role == 'user' %}
                                    <div class="bg-blue-600 text-white p-4 rounded-2xl rounded-tr-none max-w-full lg:max-w-2xl">
                                        <p>{{ message.content }}</p>
                                    </div>
                                    <div class="bg-blue-100 text-blue-800 w-8 h-8 rounded-full flex items-center justify-center shrink-0">
                                        <i class="fas fa-user"></i>
                                    </div>
                                {% else %}
                                    <div class="bg-blue-100 text-blue-800 w-8 h-8 rounded-full flex items-center justify-center shrink-0">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="bg-blue-100 text-blue-800 p-4 rounded-2xl rounded-tl-none max-w-full lg:max-w-2xl prose prose-sm prose-blue">
                                        {{ message.content|markdown|safe }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Chat Input -->
    <div class="border-t border-gray-200 bg-white p-4">
        <div class="max-w-3xl mx-auto">
            <div class="relative">
                    <textarea
                            id="user-input"
                            rows="1"
                            placeholder="D√©crivez vos sympt√¥mes ou posez une question..."
                            class="w-full bg-gray-50 border border-gray-300 rounded-lg py-3 px-4 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                            onkeydown="handleKeyPress(event)"
                    ></textarea>
                <div class="absolute right-3 bottom-3 flex space-x-2">
                    <button class="text-gray-500 hover:text-blue-600">
                        <i class="far fa-smile"></i>
                    </button>
                    <button onclick="sendMessage()"
                            class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-500 text-center">
                <p>MediBot ne remplace pas un avis m√©dical professionnel. En cas d'urgence, appelez le +243.</p>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle mobile sidebar
    document.getElementById('mobile-menu-button').addEventListener('click', function () {
        document.getElementById('sidebar').classList.toggle('sidebar-open');
        document.getElementById('sidebar-overlay').classList.toggle('sidebar-overlay-open');
    });

    // Close sidebar when clicking overlay
    document.getElementById('sidebar-overlay').addEventListener('click', function () {
        document.getElementById('sidebar').classList.remove('sidebar-open');
        this.classList.remove('sidebar-overlay-open');
    });

    // Auto-resize textarea
    const textarea = document.getElementById('user-input');
    textarea.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    function newChat() {
        // Clear chat messages (keep welcome message)
        document.getElementById('chat-messages').innerHTML = `
                <div class="flex items-start space-x-3 message mb-6">
                    <div class="bg-blue-100 text-blue-800 w-8 h-8 rounded-full flex items-center justify-center shrink-0">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="bg-blue-100 text-blue-800 p-4 rounded-2xl rounded-tl-none max-w-full lg:max-w-3xl">
                        <p class="font-medium">Nouvelle discussion</p>
                        <p class="mt-1">Comment puis-je vous aider aujourd'hui?</p>
                    </div>
                </div>
            `;

        // Add to chat history
        const historyItem = document.createElement('div');
        historyItem.className = 'px-2 py-2 rounded-lg hover:bg-gray-100 cursor-pointer flex items-center justify-between bg-gray-100';
        historyItem.innerHTML = `
                <span class="truncate"><i class="fas fa-comment-medical mr-2 text-blue-500"></i>Nouvelle discussion</span>
                <i class="fas fa-ellipsis-v text-gray-400 hover:text-gray-600"></i>
            `;
        document.getElementById('chat-history').prepend(historyItem);

        // Remove active class from other items
        document.querySelectorAll('#chat-history > div').forEach(item => {
            item.classList.remove('bg-gray-100');
        });
        historyItem.classList.add('bg-gray-100');
    }

    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById('user-input');
        const texte = `{{ symptomes_texte|escapejs }}`;
        if (texte) {
            input.value = texte;
        }
    });

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const message = input.value.trim();
        if (!message) return;
        addMessage(message, 'user');
        input.value = '';
        input.style.height = 'auto';
        showTypingIndicator();

        // 1. On envoie la requ√™te pour d√©marrer l'analyse (POST)
        const response = await fetch('/analyse/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({message: message})
        });

        if (!response.ok) {
            removeTypingIndicator();
            addMessage("Une erreur est survenue. Veuillez r√©essayer.", 'bot');
            return;
        }
        const data = await response.json();

        console.log(data);

        if (data.status === "done") {
            removeTypingIndicator();
            addMessage(data.response, 'bot');
        } else if (data.status === "pending") {
            // 2. On poll toutes les 2s (ou moins si tu pr√©f√®res) pour savoir si le r√©sultat est pr√™t
            pollForResult(data.cache_key);
        } else {
            removeTypingIndicator();
            addMessage("Erreur inattendue.", 'bot');
        }
    }

    function pollForResult(cacheKey) {
        setTimeout(async function () {
            const response = await fetch(`/diagnostic-result/?cache_key=${encodeURIComponent(cacheKey)}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            if (!response.ok) {
                removeTypingIndicator();
                addMessage("Erreur lors de la r√©cup√©ration du r√©sultat.", 'bot');
                return;
            }
            const data = await response.json();
            if (data.status === 'done') {
                removeTypingIndicator();
                addMessage(data.response, 'bot');
            } else {
                // Continue de poller
                pollForResult(cacheKey);
            }
        }, 2000);
    }

    function sendQuickMessage(message) {
        const input = document.getElementById('user-input');
        input.value = message;
        sendMessage();
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    function addMessage(text, sender) {
        const chatContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex items-start space-x-3 message ${sender === 'user' ? 'justify-end' : ''}`;

        if (sender === 'user') {
            messageDiv.innerHTML = `
                    <div class="bg-blue-600 text-white p-4 rounded-2xl rounded-tr-none max-w-full lg:max-w-2xl">
                        <p>${text}</p>
                    </div>
                    <div class="bg-blue-100 text-blue-800 w-8 h-8 rounded-full flex items-center justify-center shrink-0">
                        <i class="fas fa-user"></i>
                    </div>
                `;
        } else {
            messageDiv.innerHTML = `
                    <div class="bg-blue-100 text-blue-800 w-8 h-8 rounded-full flex items-center justify-center shrink-0">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="bg-blue-100 text-blue-800 p-4 rounded-2xl rounded-tl-none max-w-full lg:max-w-2xl prose prose-sm prose-blue">
                        ${marked.parse(text)}
                    </div>
                `;
        }

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function showTypingIndicator() {
        const chatContainer = document.getElementById('chat-messages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'flex items-start space-x-3 message';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
                <div class="bg-blue-100 text-blue-800 w-8 h-8 rounded-full flex items-center justify-center shrink-0">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="bg-blue-100 text-blue-800 p-3 rounded-2xl rounded-tl-none w-20">
                    <div class="flex space-x-1">
                        <div class="typing-dot w-2 h-2 bg-blue-600 rounded-full"></div>
                        <div class="typing-dot w-2 h-2 bg-blue-600 rounded-full"></div>
                        <div class="typing-dot w-2 h-2 bg-blue-600 rounded-full"></div>
                    </div>
                </div>
            `;
        chatContainer.appendChild(typingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function removeTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Nouvelle conversation
    function newChat() {
        fetch('/new-conversation/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Recharger la page ou mettre √† jour l'interface
                    window.location.reload();
                }
            });
    }

    // Charger une conversation existante
    function loadConversation(conversationId) {
        fetch(`/get-conversation/${conversationId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.messages) {
                    // Effacer les messages actuels
                    document.getElementById('chat-messages').innerHTML = '';

                    // Ajouter les messages de la conversation
                    data.messages.forEach(msg => {
                        addMessage(msg.content, msg.role === 'user' ? 'user' : 'bot');
                    });

                    // Mettre en surbrillance la conversation s√©lectionn√©e
                    document.querySelectorAll('#chat-history > div').forEach(item => {
                        item.classList.remove('bg-gray-100');
                    });
                    event.currentTarget.classList.add('bg-gray-100');
                }
            });
    }

    // Options de conversation (suppression, etc.)
    function showConversationOptions(event, conversationId) {
        // Impl√©mentez un menu contextuel ou une modal pour les options
        console.log(`Options pour la conversation ${conversationId}`);
        // Exemple: confirmation de suppression
        if (confirm('Voulez-vous supprimer cette conversation?')) {
            deleteConversation(conversationId);
        }
    }

    // Supprimer une conversation
    function deleteConversation(conversationId) {
        fetch(`/delete-conversation/${conversationId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Recharger ou mettre √† jour l'interface
                    window.location.reload();
                }
            });
    }
</script>
</body>
</html>